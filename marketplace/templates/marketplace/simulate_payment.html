{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Simulate Payment for {{ artifact.title }}</title>
</head>
<body>
    <h1>Payment for {{ artifact.title }}</h1>
    <p>Price: ${{ artifact.bidding_price }}</p>
    {% if error %}
        <p style="color:red;">{{ error }}</p>
    {% endif %}
    <!-- Hidden fields for PKI signing -->
    <form id="paymentForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="message" id="messageField">
        <input type="hidden" name="signature" id="signatureField">
        <button type="submit">Confirm Purchase</button>
    </form>
    <p><a href="{% url 'marketplace:artifact_detail' artifact.pk %}">Back to Item Details</a></p>
    
    <!-- Load the key management script -->
    <script src="{% static 'marketplace/keymanage.js' %}"></script>
    
    <script>
        // On page load, ensure the private key exists; if not, generate and upload key pair.
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                await loadPrivateKey();
                console.log("Private key exists in IndexedDB.");
            } catch (err) {
                console.warn(err.message);
                await generateAndUploadKeyPair();
            }
        });

        const form = document.getElementById('paymentForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const artifactId = "{{ artifact.pk }}";
            const buyerId = "{{ request.user.id }}";
            const price = "{{ artifact.bidding_price }}";
            // Construct a simple message string (adjust as needed)
            const message = `${artifactId}|${buyerId}|${price}`;
            document.getElementById('messageField').value = message;

            try {
                const privateKey = await loadPrivateKey();
                console.log("Loaded private key, is CryptoKey:", privateKey instanceof CryptoKey);
                const encoder = new TextEncoder();
                const signatureBuffer = await window.crypto.subtle.sign(
                    { name: "RSASSA-PKCS1-v1_5" },
                    privateKey,
                    encoder.encode(message)
                );
                const signatureBase64 = btoa(String.fromCharCode(...new Uint8Array(signatureBuffer)));
                document.getElementById('signatureField').value = signatureBase64;
                form.requestSubmit();
            } catch (err) {
                alert("Private key not found or signing failed.");
                console.error("Signing error:", err);
            }
        });
    </script>
</body>
</html>
